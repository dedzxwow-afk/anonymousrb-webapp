<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>AnonymousRB Terminal</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0a0a0a; --bg-rgb:10,10,10;
      --card:#141414; --card-2:#101010;
      --text:#ffffff; --text-dim:#8c8c8c;
      --accent:#ffffff; --gold:#ffd700;
      --brd:rgba(255,255,255,.10); --brd-2:rgba(255,255,255,.06);
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --soft-shadow: 0 10px 30px rgba(0,0,0,.22);
      --ease: cubic-bezier(.2,.8,.2,1);
    }
    .light-theme{
      --bg:#f5f5f7; --bg-rgb:245,245,247;
      --card:#ffffff; --card-2:#fbfbfd;
      --text:#1d1d1f; --text-dim:#6e6e73;
      --accent:#000000;
      --brd:rgba(0,0,0,.07); --brd-2:rgba(0,0,0,.05);
      --shadow: 0 18px 45px rgba(0,0,0,.10);
      --soft-shadow: 0 10px 26px rgba(0,0,0,.10);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","Helvetica Neue",Arial,sans-serif;
      transition: background .35s var(--ease), color .35s var(--ease);
      overflow:hidden;
    }

    /* ===== Background with masks ===== */
    .bg-wrap{
      position: fixed; inset: 0; z-index: 0;
      pointer-events: none; overflow: hidden;
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(255,215,0,.08), transparent 60%),
        radial-gradient(900px 600px at 85% 30%, rgba(255,255,255,.06), transparent 55%),
        radial-gradient(900px 600px at 50% 100%, rgba(255,215,0,.05), transparent 62%),
        linear-gradient(180deg, rgba(var(--bg-rgb),1) 0%, rgba(var(--bg-rgb),1) 60%, rgba(var(--bg-rgb),.92) 100%);
      transition: background .35s var(--ease);
    }
    .bg-masks{ position:absolute; inset:0; }
    .bg-mask{
      position:absolute; width: var(--size, 280px);
      opacity: var(--op, .06);
      filter: drop-shadow(0 18px 50px rgba(0,0,0,.25));
      mix-blend-mode: soft-light;
      transform: translate3d(0,0,0) rotate(var(--rot, 0deg));
      animation: floaty var(--dur, 18s) var(--ease) infinite;
      animation-delay: var(--delay, 0s);
      will-change: transform;
    }
    .light-theme .bg-mask{
      opacity: calc(var(--op, .06) + .03);
      mix-blend-mode: multiply;
      filter: drop-shadow(0 14px 40px rgba(0,0,0,.10));
    }
    @keyframes floaty{
      0%{ transform: translate3d(0,0,0) rotate(var(--rot,0deg)) scale(var(--scale,1)); }
      50%{ transform: translate3d(var(--dx,22px), var(--dy,-40px),0) rotate(calc(var(--rot,0deg) + 10deg)) scale(var(--scale,1)); }
      100%{ transform: translate3d(0,0,0) rotate(var(--rot,0deg)) scale(var(--scale,1)); }
    }
    .bg-noise{
      position:absolute; inset:-40%; opacity:.07;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
      mix-blend-mode:overlay;
      animation:noiseMove 10s linear infinite;
      transform:translate3d(0,0,0);
    }
    @keyframes noiseMove{
      0%{ transform: translate3d(-3%,-2%,0) }
      50%{ transform: translate3d(2%,3%,0) }
      100%{ transform: translate3d(-3%,-2%,0) }
    }

    /* ===== Layout ===== */
    .app-container{
      position:relative; z-index:1;
      height:100vh; display:flex; flex-direction:column;
      padding-bottom: 92px;
    }
    .header{
      position:sticky; top:0; z-index:5;
      padding:18px 18px 14px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom: 1px solid var(--brd);
      background: rgba(var(--bg-rgb), .72);
      backdrop-filter: blur(18px);
    }
    .logo{
      display:flex; align-items:center; gap:10px;
      font-size:16px; font-weight:900; letter-spacing:-.3px;
    }
    .logo-badge{
      width:28px; height:28px; border-radius:10px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid var(--brd);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      box-shadow: var(--soft-shadow);
      color: var(--gold);
    }
    .header-actions{ display:flex; gap:10px; }
    .icon-btn{
      width:40px; height:40px; border-radius:14px;
      border:1px solid var(--brd);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      color:var(--text);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; opacity:.92;
      transition: transform .18s var(--ease), opacity .18s var(--ease), border-color .18s var(--ease);
      user-select:none;
      font-weight: 900;
      font-size: 12px;
    }
    .icon-btn:active{ transform:scale(.95); opacity:1; border-color: var(--brd-2); }

    .page{
      display:none; flex:1; padding:18px;
      overflow-y:auto; animation: slideUp .35s var(--ease);
      scrollbar-width:none;
    }
    .page::-webkit-scrollbar{ width:0; height:0; }
    .page.active{ display:block; }
    @keyframes slideUp{ from{opacity:0; transform:translateY(14px)} to{opacity:1; transform:translateY(0)} }

    .card{
      background: linear-gradient(180deg, var(--card) 0%, var(--card-2) 100%);
      border:1px solid var(--brd);
      border-radius: 26px;
      box-shadow: var(--shadow);
    }

    /* ===== Balance ===== */
    .balance-card{
      padding:26px 22px; text-align:center;
      margin-bottom:22px; position:relative; overflow:hidden;
    }
    .balance-card::before{
      content:""; position:absolute; inset:-2px;
      background:
        radial-gradient(500px 200px at 20% 0%, rgba(255,215,0,.12), transparent 55%),
        radial-gradient(500px 200px at 80% 0%, rgba(255,255,255,.10), transparent 55%);
      opacity:.9; pointer-events:none;
    }
    .balance-card>*{ position:relative; z-index:1; }
    .bal-title{ font-size:11px; color:var(--text-dim); text-transform:uppercase; letter-spacing:1.2px; margin-bottom:8px; }
    .bal-amount{ font-size:44px; line-height:1; font-weight:900; letter-spacing:-1px; color:var(--gold); margin:10px 0 14px; }

    .chip{
      display:inline-flex; align-items:center; gap:10px;
      padding:9px 14px; border-radius:999px;
      border:1px solid var(--brd);
      background: rgba(255,255,255,.04);
      color:var(--text); font-size:12px; cursor:pointer; opacity:.92;
      transition: transform .18s var(--ease), opacity .18s var(--ease);
      user-select:none;
    }
    .chip:active{ transform:scale(.97); opacity:1; }

    /* ===== Clicker ===== */
    .clicker-section{
      display:flex; flex-direction:column; align-items:center;
      gap:18px; padding-bottom:6px;
    }
    .orb{
      width:210px; height:210px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; position:relative;
      background:
        radial-gradient(120px 120px at 35% 25%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(240px 240px at 50% 70%, rgba(255,215,0,.06), transparent 55%),
        linear-gradient(180deg, var(--card) 0%, var(--card-2) 100%);
      border:1px solid var(--brd);
      box-shadow: 0 26px 70px rgba(0,0,0,.35);
      transition: transform .10s ease, box-shadow .18s var(--ease), border-color .18s var(--ease);
      user-select:none;
    }
    .orb::before{
      content:""; position:absolute; inset:-10px; border-radius:inherit;
      background: radial-gradient(circle, rgba(255,255,255,.18), transparent 60%);
      opacity:.25; filter: blur(2px);
      animation: pulse 2.4s var(--ease) infinite;
      pointer-events:none;
    }
    @keyframes pulse{ 0%{transform:scale(.98);opacity:.18} 50%{transform:scale(1.04);opacity:.32} 100%{transform:scale(.98);opacity:.18} }
    .orb:active{
      transform: scale(.93);
      box-shadow: 0 18px 55px rgba(0,0,0,.35), 0 0 42px rgba(255,255,255,.18);
      border-color: rgba(255,255,255,.22);
    }
    .orb-mark{
      font-size:78px; color:var(--gold);
      text-shadow: 0 18px 60px rgba(255,215,0,.10);
      transform: translateY(-2px);
      user-select:none;
    }

    .floating-text{
      position:fixed; pointer-events:none; font-weight:900; color:var(--gold);
      text-shadow: 0 10px 35px rgba(255,215,0,.14);
      transform: translate(-50%,-50%);
      animation: float .75s forwards;
      z-index: 9;
    }
    @keyframes float{ 0%{transform:translate(-50%,-50%) translateY(0);opacity:1} 100%{transform:translate(-50%,-50%) translateY(-90px);opacity:0} }

    /* ===== Forms / Buttons ===== */
    .section-card{ padding:14px; border-radius:22px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .btn-main{
      width:100%; padding:15px 14px; border-radius:14px;
      border:1px solid var(--brd);
      background: var(--accent); color: var(--bg);
      font-weight:900; font-size:16px;
      cursor:pointer; user-select:none;
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .btn-ghost{
      width:100%; padding:15px 14px; border-radius:14px;
      border:1px solid var(--brd);
      background: rgba(255,255,255,.03);
      color: var(--text);
      font-weight:900; font-size:16px;
      cursor:pointer; user-select:none;
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .btn-small{
      width:auto; padding:10px 12px; border-radius:12px;
      border:1px solid var(--brd);
      background: rgba(255,255,255,.03);
      color: var(--text);
      font-weight:900; font-size:12px;
      cursor:pointer; user-select:none;
    }
    .field{
      width:100%; padding:15px 14px; border-radius:14px;
      border:1px solid var(--brd);
      background: rgba(255,255,255,.03);
      color:var(--text); font-size:16px; outline:none;
    }
    .sub{
      margin:0 0 14px; color:var(--text-dim);
      font-size:13px; line-height:1.35;
    }
    h2{ margin:6px 0 14px; font-weight:900; letter-spacing:-.5px; }

    /* Withdraw list */
    .w-item{ padding:10px 0; border-bottom:1px solid var(--brd); }
    .w-item:last-child{ border-bottom:none; }
    .w-top{ display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .w-status{ color:var(--gold); font-weight:900; }
    .w-meta{ opacity:.75; margin-top:6px; font-size:12px; line-height:1.35; }

    /* Nav */
    .nav-bar{
      position:fixed; left:0; right:0; bottom:0;
      height:82px; z-index:10;
      display:flex; justify-content:space-around; align-items:center;
      padding-bottom: env(safe-area-inset-bottom);
      border-top:1px solid var(--brd);
      background: rgba(var(--bg-rgb), .75);
      backdrop-filter: blur(18px);
    }
    .nav-item{
      flex:1 1 0; max-width:90px;
      display:flex; flex-direction:column; align-items:center; gap:6px;
      color:var(--text-dim); text-decoration:none;
      font-size:10px; font-weight:900;
      padding:10px 0 8px; border-radius:18px;
      transition: color .2s var(--ease), background .2s var(--ease), transform .18s var(--ease);
      user-select:none;
    }
    .nav-item.active{ color:var(--accent); background: rgba(255,255,255,.04); }
    .nav-item:active{ transform:scale(.98); }

    .toast{
      position:fixed; left:50%; bottom:98px; transform: translateX(-50%);
      background: rgba(var(--bg-rgb), .78);
      border:1px solid var(--brd);
      color:var(--text);
      padding:10px 12px; border-radius:999px;
      backdrop-filter: blur(16px);
      font-size:12px; font-weight:900;
      opacity:0; pointer-events:none;
      transition: opacity .22s var(--ease), transform .22s var(--ease);
      z-index:20; white-space:nowrap;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-6px); }
  </style>
</head>

<body>
  <div class="bg-wrap" aria-hidden="true">
    <div class="bg-masks" id="bgMasks"></div>
    <div class="bg-noise"></div>
  </div>

  <div class="app-container">
    <div class="header">
      <div class="logo">
        <div class="logo-badge">‚öúÔ∏è</div>
        <div>AnonymousRB</div>
      </div>
      <div class="header-actions">
        <button class="icon-btn" id="sfxBtn" onclick="toggleSfx()">SFX</button>
        <button class="icon-btn" onclick="toggleTheme()">‚óê</button>
      </div>
    </div>

    <!-- HOME -->
    <div id="home" class="page active">
      <div class="balance-card card">
        <div class="bal-title">–í–∞—à –∫–∞–ø–∏—Ç–∞–ª</div>
        <div class="bal-amount" id="bal">0.000 R$</div>
        <button class="chip" onclick="claimBonus()">üéÅ –ë–æ–Ω—É—Å <b style="color:var(--gold)">0.7 R$</b></button>
      </div>

      <div class="clicker-section">
        <div class="orb" id="orb" aria-label="clicker">
          <div class="orb-mark">‚öúÔ∏è</div>
        </div>

        <div class="card section-card" style="width:100%; max-width:560px;">
          <p class="sub" style="margin:0;">
            ‚öúÔ∏è –ù–∞—á–∏—Å–ª–µ–Ω–∏—è/–≤—ã–≤–æ–¥ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –±–æ—Ç–æ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.<br>
            –ò—Å—Ç–æ—Ä–∏—è –≤—ã–≤–æ–¥–æ–≤ –≤–∏–¥–Ω–∞ –≤ —ç—Ç–æ–π WebApp –≤–æ –≤–∫–ª–∞–¥–∫–µ ‚Äú–í—ã–≤–æ–¥‚Äù.
          </p>
          <div style="height:12px"></div>
          <div class="row">
            <button class="btn-ghost" style="flex:1" onclick="requestRef()">üîó –†–µ—Ñ-—Å—Å—ã–ª–∫–∞</button>
            <button class="btn-ghost" style="flex:1" onclick="tab('wallet', document.querySelectorAll('.nav-item')[2]);">üí∏ –í—ã–≤–æ–¥</button>
          </div>
        </div>
      </div>
    </div>

    <!-- TOP -->
    <div id="top" class="page">
      <h2>‚öúÔ∏è –õ–∏–¥–µ—Ä—ã</h2>
      <p class="sub">–¢–æ–ø —Å–º–æ—Ç—Ä–∏ –≤ –±–æ—Ç–µ: ¬´üèÜ –¢–æ–ø –ª–∏–¥–µ—Ä–æ–≤¬ª</p>
      <div class="card section-card">
        <div style="opacity:.85; font-weight:900;">–û—Ç–∫—Ä–æ–π ‚ÄúüèÜ –¢–æ–ø –ª–∏–¥–µ—Ä–æ–≤‚Äù –≤ —á–∞—Ç–µ –±–æ—Ç–∞</div>
      </div>
    </div>

    <!-- WALLET -->
    <div id="wallet" class="page">
      <h2>‚öúÔ∏è –í—ã–≤–æ–¥</h2>
      <p class="sub">
        –ú–∏–Ω–∏–º—É–º: <b>30 R$</b>. –£–∫–∞–∂–∏ <b>—Å—Å—ã–ª–∫—É –Ω–∞ Roblox Gamepass</b>.<br>
        –°—Ç–∞—Ç—É—Å –ø–æ—è–≤–∏—Ç—Å—è –Ω–∏–∂–µ (—Å —Å–µ—Ä–≤–µ—Ä–∞).
      </p>

      <input class="field" id="w-amount" type="number" placeholder="–°—É–º–º–∞ R$" inputmode="decimal">
      <div style="height:10px"></div>
      <input class="field" id="w-address" type="text" placeholder="https://www.roblox.com/game-pass/ID/NAME">
      <div style="height:10px"></div>

      <button class="btn-main" onclick="sendWithdraw()">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É</button>

      <div style="height:14px"></div>

      <div class="card section-card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <div style="font-weight:900;">–°—Ç–∞—Ç—É—Å –≤—ã–≤–æ–¥–æ–≤</div>
          <button class="btn-small" onclick="refreshWithdrawals()">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>

        <div style="height:10px"></div>
        <div class="sub" id="serverBalanceText" style="margin:0;">–°–µ—Ä–≤–µ—Ä–Ω—ã–π –±–∞–ª–∞–Ω—Å: ‚Äî</div>

        <div style="height:12px"></div>
        <div id="withdrawList" class="sub" style="margin:0; line-height:1.45;">‚Äî</div>
      </div>

      <p class="sub" style="margin-top:12px;">
        ‚ö†Ô∏è –ë–∞–ª–∞–Ω—Å –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ (–Ω–∞ –≥–ª–∞–≤–Ω–æ–π) ‚Äî –≤–∏–∑—É–∞–ª—å–Ω—ã–π. –†–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å ‚Äî —Å–µ—Ä–≤–µ—Ä–Ω—ã–π (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤—ã—à–µ).
      </p>
    </div>

    <!-- PROFILE -->
    <div id="profile" class="page">
      <h2>‚öúÔ∏è –ü—Ä–æ—Ñ–∏–ª—å</h2>
      <p class="sub">–ü—Ä–æ—Ñ–∏–ª—å/—Ä–µ—Ñ-—Å—Å—ã–ª–∫—É –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç –≤ —á–∞—Ç.</p>
      <button class="btn-main" onclick="requestRef()">üîó –ü–æ–ª—É—á–∏—Ç—å —Ä–µ—Ñ-—Å—Å—ã–ª–∫—É</button>
    </div>

    <!-- ABOUT -->
    <div id="about" class="page">
      <h2>‚öúÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ</h2>
      <p class="sub">AnonymousRB ‚Äî –∑–∞–∫—Ä—ã—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –∑–∞—Ä–∞–±–æ—Ç–∫–∞ R$ –≤ Telegram WebApp.</p>
      <div class="card section-card">
        <div style="font-weight:900; margin-bottom:8px;">–ü–ª—é—Å—ã</div>
        <div class="sub" style="margin:0;">
          ‚Ä¢ –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª –∏ –ø—Ä–æ—Å—Ç–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.<br>
          ‚Ä¢ –°–µ—Ä–≤–µ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–æ–Ω—É—Å–æ–≤ –∏ –≤—ã–≤–æ–¥–æ–≤.<br>
          ‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ (–∫–Ω–æ–ø–∫–∞ ¬´üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞¬ª).
        </div>
      </div>
    </div>

    <!-- NAV -->
    <nav class="nav-bar">
      <a href="#" class="nav-item active" onclick="tab('home', this)">–ì–ª–∞–≤–Ω–∞—è</a>
      <a href="#" class="nav-item" onclick="tab('top', this)">–¢–æ–ø</a>
      <a href="#" class="nav-item" onclick="tab('wallet', this)">–í—ã–≤–æ–¥</a>
      <a href="#" class="nav-item" onclick="tab('profile', this)">–ü—Ä–æ—Ñ–∏–ª—å</a>
      <a href="#" class="nav-item" onclick="tab('about', this)">–û –Ω–∞—Å</a>
    </nav>
  </div>

  <div class="toast" id="toast">–ì–æ—Ç–æ–≤–æ</div>

  <script>
    // ===================== API BASE =====================
    // –í–°–¢–ê–í–¨ –°–Æ–î–ê –î–û–ú–ï–ù –ë–û–¢–ê –° API (aiohttp), –Ω–∞–ø—Ä–∏–º–µ—Ä:
    // const API_BASE = "https://anonymousrb-bot.onrender.com";
    const API_BASE = "https://YOUR_BOT_DOMAIN";

    const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    if (tg) { try { tg.expand(); } catch(e){} }

    function syncHeaderColor(){
      if (!tg) return;
      const bg = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim();
      try { tg.headerColor = bg; } catch(e){}
      try { if (tg.setHeaderColor) tg.setHeaderColor(bg); } catch(e){}
    }
    syncHeaderColor();

    let toastTimer = null;
    function showToast(text){
      const t = document.getElementById('toast');
      t.textContent = text;
      t.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => t.classList.remove('show'), 1400);
    }

    function toggleTheme(){
      document.body.classList.toggle("light-theme");
      syncHeaderColor();
      SFX.click();
      hapticLight();
    }

    function hapticLight(){
      if (!tg?.HapticFeedback) return;
      try { tg.HapticFeedback.impactOccurred('light'); } catch(e){}
    }
    function hapticSelect(){
      if (!tg?.HapticFeedback) return;
      try { tg.HapticFeedback.selectionChanged(); } catch(e){}
    }

    // Masks
    const MASK_SRC = "222.png";
    const masksConfig = [
      { left: "-8%", top: "10%", size: 340, op: 0.06, dur: 22, delay: -2, rot: -12, dx: 18, dy: -38, scale: 1.0 },
      { left: "62%", top: "-6%", size: 380, op: 0.05, dur: 26, delay: -6, rot:  10, dx: -22, dy:  46, scale: 1.05 },
      { left: "78%", top: "52%", size: 300, op: 0.05, dur: 21, delay: -4, rot:  18, dx: -16, dy: -34, scale: 0.98 },
      { left: "10%", top: "58%", size: 320, op: 0.05, dur: 24, delay: -9, rot: -18, dx:  20, dy:  42, scale: 1.02 },
      { left: "36%", top: "26%", size: 280, op: 0.04, dur: 19, delay: -1, rot:   6, dx: -12, dy: -28, scale: 0.95 },
    ];
    (function initMasks(){
      const bgMasks = document.getElementById("bgMasks");
      bgMasks.innerHTML = "";
      masksConfig.forEach((m) => {
        const img = document.createElement("img");
        img.className = "bg-mask";
        img.src = MASK_SRC;
        img.alt = "";
        img.style.left = m.left;
        img.style.top = m.top;
        img.style.setProperty("--size", m.size + "px");
        img.style.setProperty("--op", m.op);
        img.style.setProperty("--dur", m.dur + "s");
        img.style.setProperty("--delay", m.delay + "s");
        img.style.setProperty("--rot", m.rot + "deg");
        img.style.setProperty("--dx", m.dx + "px");
        img.style.setProperty("--dy", m.dy + "px");
        img.style.setProperty("--scale", m.scale);
        bgMasks.appendChild(img);
      });
    })();

    // Navigation
    function tab(id, el){
      document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
      document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      el.classList.add("active");
      SFX.click();
      hapticSelect();

      if (id === "wallet") setTimeout(refreshWithdrawals, 200);
    }

    // ===== SFX =====
    const SFX = (() => {
      let ctx = null;
      let enabled = true;

      function ensure(){
        if (!enabled) return null;
        if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
        if (ctx.state === "suspended") ctx.resume().catch(()=>{});
        return ctx;
      }
      function tone({freq=600, dur=0.06, type="triangle", gain=0.08, lp=1400} = {}){
        const c = ensure(); if (!c) return;
        const o = c.createOscillator();
        const g = c.createGain();
        const f = c.createBiquadFilter();
        f.type = "lowpass";
        f.frequency.value = lp;

        o.type = type;
        o.frequency.setValueAtTime(freq, c.currentTime);

        g.gain.setValueAtTime(0.0001, c.currentTime);
        g.gain.exponentialRampToValueAtTime(gain, c.currentTime + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, c.currentTime + dur);

        o.connect(f); f.connect(g); g.connect(c.destination);
        o.start(); o.stop(c.currentTime + dur + 0.02);
      }
      function click(){ tone({freq:760, dur:0.045, type:"triangle", gain:0.06, lp:1800}); }
      function coin(){
        tone({freq:740, dur:0.06, type:"sine", gain:0.07, lp:2200});
        setTimeout(()=>tone({freq:990, dur:0.05, type:"sine", gain:0.06, lp:2400}), 35);
      }
      function confirm(){
        tone({freq:520, dur:0.07, type:"sine", gain:0.06, lp:1800});
        setTimeout(()=>tone({freq:780, dur:0.07, type:"sine", gain:0.05, lp:2000}), 65);
      }
      function toggle(){ enabled = !enabled; return enabled; }

      window.addEventListener("pointerdown", () => ensure(), { once:true });
      return { click, coin, confirm, toggle };
    })();

    function toggleSfx(){
      const on = SFX.toggle();
      document.getElementById("sfxBtn").textContent = on ? "SFX" : "SFX√ó";
      if (on) SFX.click();
      showToast(on ? "SFX –≤–∫–ª—é—á–µ–Ω—ã" : "SFX –≤—ã–∫–ª—é—á–µ–Ω—ã");
      hapticLight();
    }

    // ===== WebApp bot actions (JSON+initData) =====
    function sendToBot(payload){
      if (!tg) { showToast("–û—Ç–∫—Ä–æ–π –∏–∑ Telegram"); return; }
      payload.initData = tg.initData || "";
      try { tg.sendData(JSON.stringify(payload)); } catch(e){}
    }

    // ===== API helpers =====
    function initDataHeader(){
      return { "X-TG-INITDATA": (tg?.initData || "") };
    }
    async function apiGet(path){
      const r = await fetch(API_BASE + path, { method:"GET", headers: { ...initDataHeader() } });
      return await r.json();
    }
    async function apiPost(path, body){
      const r = await fetch(API_BASE + path, {
        method:"POST",
        headers: { "Content-Type":"application/json", ...initDataHeader() },
        body: JSON.stringify(body)
      });
      return await r.json();
    }

    // ===== Clicker =====
    let balance = 0.00;
    try { balance = Number(localStorage.getItem("bal_ui") || "0") || 0; } catch(e){ balance = 0; }
    const balEl = document.getElementById("bal");
    balEl.textContent = balance.toFixed(3) + " R$";

    const REWARD_PER_CLICK = 0.0013;
    let pendingClicks = 0;
    const CLICK_FLUSH_MS = 2000;
    const CLICK_FLUSH_MAX = 30;

    function flushClicks(reason="timer"){
      if (pendingClicks <= 0) return;
      sendToBot({ a: "click_batch", c: pendingClicks, r: reason, ts: Date.now() });
      pendingClicks = 0;
    }
    setInterval(() => flushClicks("timer"), CLICK_FLUSH_MS);

    // client flags
    const Anti = { last: 0, times: [], blockedUntil: 0, score: 0 };
    const MIN_INTERVAL_MS = 70;
    const MAX_CPS = 12;

    function cpsNow(){
      const now = performance.now();
      Anti.times = Anti.times.filter(t => now - t < 1000);
      return Anti.times.length;
    }
    function intervalsVariance(arr){
      if (arr.length < 6) return 999;
      const ints = [];
      for (let i=1;i<arr.length;i++) ints.push(arr[i]-arr[i-1]);
      const avg = ints.reduce((a,b)=>a+b,0)/ints.length;
      const v = ints.reduce((a,b)=>a+(b-avg)*(b-avg),0)/ints.length;
      return v;
    }
    function flag(reason, extra = {}){
      Anti.score += 2;
      sendToBot({ a: "anticheat", reason, score: Anti.score, ...extra, ts: Date.now() });
      if (Anti.score >= 6) {
        Anti.blockedUntil = Date.now() + 12000;
        flushClicks("flag");
        try { tg?.showAlert("–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å. –ù–∞—á–∏—Å–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."); } catch(e){}
      }
    }

    const orb = document.getElementById("orb");
    orb.addEventListener("click", (e) => {
      if (Date.now() < Anti.blockedUntil) return;
      if (!e.isTrusted) { flag("untrusted_event"); return; }

      const now = performance.now();
      if (Anti.last && (now - Anti.last) < MIN_INTERVAL_MS) {
        flag("too_fast", { dt: Math.round(now - Anti.last) });
        return;
      }
      Anti.last = now;

      Anti.times.push(now);
      const cps = cpsNow();
      if (cps > MAX_CPS) {
        flag("cps_limit", { cps });
        Anti.blockedUntil = Date.now() + 5000;
        flushClicks("flag");
        return;
      }

      const last12 = Anti.times.slice(-12);
      const variance = intervalsVariance(last12);
      if (last12.length >= 10 && variance < 8) {
        flag("robotic_intervals", { variance: Number(variance.toFixed(2)) });
        return;
      }

      balance += REWARD_PER_CLICK;
      balEl.textContent = balance.toFixed(3) + " R$";
      try { localStorage.setItem("bal_ui", String(balance)); } catch(e){}

      pendingClicks += 1;
      if (pendingClicks >= CLICK_FLUSH_MAX) flushClicks("max");

      const float = document.createElement("div");
      float.className = "floating-text";
      float.style.left = e.clientX + "px";
      float.style.top  = e.clientY + "px";
      float.textContent = "+" + REWARD_PER_CLICK.toFixed(4);
      document.body.appendChild(float);
      setTimeout(()=>float.remove(), 800);

      SFX.coin();
      hapticSelect();
    });

    // ===== Actions =====
    function claimBonus(){
      sendToBot({ a: "daily_bonus", ts: Date.now() });
      SFX.confirm(); hapticLight();
      showToast("–ó–∞–ø—Ä–æ—Å –±–æ–Ω—É—Å–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω");
    }

    function looksLikeGamepass(url){
      try{
        const u = new URL(url);
        if (!u.hostname.endsWith("roblox.com")) return false;
        const p = u.pathname.toLowerCase();
        const has = p.includes("/game-pass/") || p.includes("/gamepass/");
        if (!has) return false;
        const tail = p.includes("/game-pass/") ? p.split("/game-pass/")[1] : p.split("/gamepass/")[1];
        const id = (tail.split("/")[0] || "").trim();
        return /^\d+$/.test(id);
      }catch(e){ return false; }
    }

    async function sendWithdraw(){
      if (!tg) { showToast("–û—Ç–∫—Ä–æ–π –∏–∑ Telegram"); return; }
      if (!API_BASE || API_BASE.includes("YOUR_BOT_DOMAIN")) { showToast("–£–∫–∞–∂–∏ API_BASE"); return; }

      const amt = Number(document.getElementById("w-amount").value || 0);
      const link = (document.getElementById("w-address").value || "").trim();

      if (amt < 30) { showToast("–ú–∏–Ω–∏–º—É–º 30 R$"); return; }
      if (!looksLikeGamepass(link)) { showToast("–ù—É–∂–Ω–∞ –≤–∞–ª–∏–¥–Ω–∞—è —Å—Å—ã–ª–∫–∞ Gamepass"); return; }

      try{
        const res = await apiPost("/api/withdraw", { amount: amt, link });
        if (!res.ok){
          const e = res.error || "error";
          if (e === "insufficient_funds") showToast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ (—Å–µ—Ä–≤–µ—Ä)");
          else if (e === "pending_exists") showToast("–£–∂–µ –µ—Å—Ç—å pending –∑–∞—è–≤–∫–∞");
          else if (e === "min_withdraw") showToast("–ú–∏–Ω–∏–º—É–º 30 R$");
          else if (e === "bad_gamepass") showToast("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞ Gamepass");
          else showToast("–û—à–∏–±–∫–∞: " + e);
          return;
        }
        showToast("–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞: #" + res.withdraw_id);
        await refreshWithdrawals();
      }catch(e){
        showToast("API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
      }
    }

    function requestRef(){
      sendToBot({ a: "get_ref", ts: Date.now() });
      SFX.click(); hapticLight();
      showToast("–°—Å—ã–ª–∫–∞ –ø—Ä–∏–¥—ë—Ç –≤ —á–∞—Ç");
    }

    function fmtTs(ts){
      if (!ts) return "";
      const d = new Date(ts * 1000);
      return d.toLocaleString();
    }
    function statusLabel(s){
      if (s === "pending") return "‚è≥ pending";
      if (s === "approved") return "‚úÖ approved";
      if (s === "paid") return "üí∏ paid";
      if (s === "rejected") return "‚ùå rejected";
      return s;
    }

    async function refreshWithdrawals(){
      if (!tg) return;
      if (!API_BASE || API_BASE.includes("YOUR_BOT_DOMAIN")) return;

      try{
        const p = await apiGet("/api/profile");
        if (!p.ok){ showToast("API: " + (p.error || "–æ—à–∏–±–∫–∞")); return; }
        document.getElementById("serverBalanceText").textContent =
          "–°–µ—Ä–≤–µ—Ä–Ω—ã–π –±–∞–ª–∞–Ω—Å: " + Number(p.balance).toFixed(3) + " R$";

        const w = await apiGet("/api/withdrawals?limit=10");
        if (!w.ok){ showToast("API: " + (w.error || "–æ—à–∏–±–∫–∞")); return; }

        const list = document.getElementById("withdrawList");
        if (!w.items || w.items.length === 0){
          list.textContent = "–ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç.";
          return;
        }

        list.innerHTML = w.items.map(it => {
          return `
            <div class="w-item">
              <div class="w-top">
                <div><b>#${it.id}</b> ‚Äî <b>${Number(it.amount).toFixed(2)} R$</b></div>
                <div class="w-status">${statusLabel(it.status)}</div>
              </div>
              <div class="w-meta">
                –°–æ–∑–¥–∞–Ω–æ: ${fmtTs(it.created_at)}
                ${it.reviewed_at ? " ‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: " + fmtTs(it.reviewed_at) : ""}
                ${it.note ? " ‚Ä¢ " + it.note : ""}
              </div>
            </div>
          `;
        }).join("");

      }catch(e){
        showToast("API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
      }
    }

    window.addEventListener("beforeunload", () => {
      flushClicks("unload");
      try { localStorage.setItem("bal_ui", String(balance)); } catch(e){}
    });
  </script>
</body>
</html>
